{{! Using main layout }}
{{#section 'head'}}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{{/section}}

<div style="margin-top: 50px;"></div>

<div class="dashboard-container">
  <div class="dashboard-header">
    <div class="dashboard-title">
      <h1>Digital Library Dashboard</h1>
      <p>Access your academic resources in one place</p>
    </div>
    <div class="dashboard-actions">
      <a href="/dashboard/Book/Add" class="action-button add-button">
        <i class="fas fa-plus"></i>
        <span>Add New Book</span>
      </a>
      <button class="action-button export-button" onclick="exportBooks()">
        <i class="fas fa-download"></i>
        <span>Export Books</span>
      </button>
    </div>
  </div>

  <div class="filter-section">
    <div class="search-box">
      <i class="fas fa-search"></i>
      <input type="text" id="searchProduct" placeholder="Search books by name..." value="{{filters.search}}" oninput="debounce(filterProducts, 500)()">
      <button type="button" id="clearSearch" class="clear-search" onclick="clearSearch()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="filter-controls">
      <div class="filter-group">
        <label for="semesterFilter">
          <i class="fas fa-graduation-cap"></i>
          <span>Semester</span>
        </label>
        <select id="semesterFilter" name="semester" onchange="filterProducts()">
          <option value="Semester1" {{#if (eq filters.semester 'Semester1')}}selected{{/if}}>Semester 1</option>
          <option value="Semester2" {{#if (eq filters.semester 'Semester2')}}selected{{/if}}>Semester 2</option>
          <option value="Semester3" {{#if (eq filters.semester 'Semester3')}}selected{{/if}}>Semester 3</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="categoryFilter">
          <i class="fas fa-book"></i>
          <span>Category</span>
        </label>
        <select id="categoryFilter" name="category" onchange="filterProducts()">
          <option value="all" {{#if (eq filters.category 'all')}}selected{{/if}}>All Categories</option>
          <option value="CourseBooks" {{#if (eq filters.category 'CourseBooks')}}selected{{/if}}>Course Books</option>
          <option value="LabManuals" {{#if (eq filters.category 'LabManuals')}}selected{{/if}}>Lab Manuals</option>
          <option value="other" {{#if (eq filters.category 'other')}}selected{{/if}}>Other</option>
        </select>
      </div>
    </div>
  </div>
      <div id="spinner" class="loading-spinner" style="display: none;">
        <div class="spinner-content">
          <div class="spinner-circle"></div>
          <p>Loading books...</p>
        </div>
      </div>

      <div class="books-grid">
        {{#if books}}
          {{#each books}}
            <div class="book-card" id="{{this.id}}">
              {{#if this.main}}
                <div class="book-badge" aria-label="Main resource">Main</div>
              {{/if}}
              
              <div class="book-cover">
                <a href="{{this.link}}" target="_blank" rel="noopener noreferrer">
                  <img src="{{this.imageURL}}" alt="Cover of {{this.name}}" loading="lazy">
                </a>
                <div class="book-overlay">
                  <div class="book-actions">
                    <a href="{{this.link}}" class="book-action-btn view-btn" target="_blank" rel="noopener noreferrer">
                      <i class="fas fa-eye"></i>
                      <span>View</span>
                    </a>
                    {{#if (eq role "SuperAdmin")}}
                      <a href="/dashboard/Book/Edit/{{this.id}}" class="book-action-btn edit-btn">
                        <i class="fas fa-edit"></i>
                        <span>Edit</span>
                      </a>
                      <button onclick="deleteProduct('{{this.id}}')" class="book-action-btn delete-btn">
                        <i class="fas fa-trash-alt"></i>
                        <span>Delete</span>
                      </button>
                    {{/if}}
                  </div>
                </div>
              </div>

              <div class="book-info">
                <div class="book-header">
                  <h3 class="book-title">{{this.name}}</h3>
                  <div class="book-actions-top">
                      <button onclick="deleteProduct('{{this.id}}')" class="book-btn delete-btn" title="Delete book">
                        <i class="fas fa-trash-alt"></i>
                      </button>
                      <a href="/dashboard/Book/Edit/{{this.id}}" class="book-btn edit-btn" title="Edit book">
                        <i class="fas fa-edit"></i>
                      </a>
                  </div>
                </div>
                <p class="book-description">{{this.description}}</p>
                <div class="book-metadata">
                  <div class="metadata-row">
                    <span class="book-category">
                      <i class="fas fa-bookmark"></i>
                      {{this.category}}
                    </span>
                    <span class="book-semester">
                      <i class="fas fa-graduation-cap"></i>
                      {{this.semester}}
                    </span>
                  </div>
                  <div class="metadata-row">
                    <span class="book-user">
                      <i class="fas fa-user"></i>
                      {{#if this.UserName}}
                        {{this.UserName}}
                      {{else}}
                        Unknown User
                      {{/if}}
                    </span>
                    <a href="{{this.link}}" class="book-btn view-btn" target="_blank" rel="noopener noreferrer" title="View book">
                      <i class="fas fa-eye"></i>
                    </a>
                  </div>
                </div>
              </div>
            </div>
          {{/each}}
        {{else}}
          <div class="no-results">
            <div class="no-results-content">
              <i class="fas fa-book-open"></i>
              <h3>No Books Found</h3>
              <p>No materials found matching your search criteria</p>
              <button class="action-button add-button" onclick="resetFilters()">
                <i class="fas fa-sync"></i>
                <span>Reset Filters</span>
              </button>
            </div>
          </div>
        {{/if}}
      </div>

      <div class="pagination" id="pagination">
        {{#if (gt pagination.pages 1)}}
        <button {{#if (eq pagination.page 1)}}disabled{{/if}} onclick="goToPage({{subtract pagination.page 1}})"
          title="Previous page">
          <i class="fas fa-chevron-left"></i>
        </button>

        {{#if (gt pagination.page 2)}}
        <button onclick="goToPage(1)" title="First page">1</button>
        {{#if (gt pagination.page 3)}}
        <span style="padding: 0 10px; color: var(--text-secondary);">...</span>
        {{/if}}
        {{/if}}

        {{#each (range (max 1 (subtract pagination.page 2)) (min pagination.pages (add pagination.page 2)))}}
        <button {{#if (eq this ../pagination.page)}}class="active" disabled{{/if}} onclick="goToPage({{this}})"
          title="Page {{this}}">{{this}}</button>
        {{/each}}

        {{#if (lt pagination.page (subtract pagination.pages 1))}}
        <span style="padding: 0 10px; color: var(--text-secondary);">...</span>
        <button onclick="goToPage({{pagination.pages}})" title="Last page">{{pagination.pages}}</button>
        {{/if}}

        <button {{#if (eq pagination.page pagination.pages)}}disabled{{/if}}
          onclick="goToPage({{add pagination.page 1}})" title="Next page">
          <i class="fas fa-chevron-right"></i>
        </button>
        {{/if}}
      </div>
      <div class="pagination-info" id="paginationInfo">
        Showing {{add (multiply (subtract pagination.page 1) pagination.limit) 1}}-{{min (multiply pagination.page
        pagination.limit) pagination.total}} of {{pagination.total}} item{{#if (gt pagination.total 1)}}s{{/if}}
      </div>
    </div>
  </section>

  <script>
    function exportBooks() {
      const url = '/api/admin/Unilib/Book/Export';
      fetch(url, { credentials: 'include' })
        .then(r => { if (!r.ok) throw new Error('Export failed'); return r.json(); })
        .then(data => {
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          const ts = new Date().toISOString().replace(/[:.]/g, '-');
          a.download = `unilib-books-${ts}.json`;
          document.body.appendChild(a); a.click(); document.body.removeChild(a);
        })
        .catch(err => { console.error(err); alert('Failed to export books.'); });
    }
    async function deleteProduct(productId) {
      if (confirm('Are you sure you want to delete this product?')) {
        try {
          const response = await fetch(`/api/admin/Unilib/Book/Delete/${productId}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          if (response.ok) {
            alert('Product deleted successfully.');
            window.location.reload();
          } else {
            alert('Failed to delete the product. Please try again.');
          }
        } catch (error) {
          console.error('Error deleting product:', error);
          alert('An error occurred while deleting the product.');
        }
      }
    }
  </script>
{{!-- {{#section 'scripts'}} Add extra page scripts here if needed {{/section}} --}}