{{#section 'head'}}
<title>Uni Books Dashboard</title>
<link rel="stylesheet" href="/Assets/Styles/common-admin.css">
{{/section}}
<section class="about {{#if singleBookView}}single-book-mode{{/if}}" id="books">
  <div class="content">
    <div class="not"></div>
    <!-- Regular Grid View -->
    <div class="title section-title">
      <h1>Uni Course Materials</h1>
    </div>
    <div class="filter">
      <div class="select-dropdown">
        <i class="fas fa-graduation-cap filter-icon"></i>
        <select id="semesterFilter" name="topics" aria-label="Select semester">
          <option value="all" {{#if (eq filters.semester 'all' )}}selected{{/if}}><i class="fas fa-layer-group"></i> All
            Semesters</option>
          <option value="Semester1" {{#if (eq filters.semester 'Semester1' )}}selected{{/if}}><i class="fas fa-1"></i>
            Semester 1</option>
          <option value="Semester2" {{#if (eq filters.semester 'Semester2' )}}selected{{/if}}><i class="fas fa-2"></i>
            Semester 2</option>
          <option value="Semester3" {{#if (eq filters.semester 'Semester3' )}}selected{{/if}}><i class="fas fa-3"></i>
            Semester 3</option>
        </select>
      </div>
      <div class="select-dropdown">
        <i class="fas fa-book filter-icon"></i>
        <select id="categoryFilter" name="topics" aria-label="Select category">
          <option value="all" {{#if (eq filters.category 'all' )}}selected{{/if}}>All Categories</option>
          <option value="CourseBooks" {{#if (eq filters.category 'CourseBooks' )}}selected{{/if}}>Course Books</option>
          <option value="Softwares" {{#if (eq filters.category 'Softwares' )}}selected{{/if}}>Softwares</option>
          <option value="Softwares" {{#if (eq filters.category 'Softwares' )}}selected{{/if}}>Softwares</option>
          <option value="other" {{#if (eq filters.category 'other' )}}selected{{/if}}>Other</option>
        </select>
      </div>
    </div>
    <div class="search-bar">
      <i class="fas fa-search search-icon"></i>
      <input type="text" id="searchProduct" placeholder="Search books by name..." value="{{filters.search}}"
        aria-label="Search books">
      <button type="button" id="searchSubmit" class="submit-btn" aria-label="Submit search">
        <i class="fas fa-arrow-right"></i>
      </button>
      <button type="button" id="clearSearch" class="clear-btn" aria-label="Clear search"
        style="display: {{#if filters.search}}block{{else}}none{{/if}};">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <button class="action-button add-button" onclick="exportBooks()" style="margin-bottom: 15px;">
      <i class="fas fa-file-export"></i> Export Books
    </button>
    <button class="action-button add-button" onclick="window.location.href='/dashboard/Book/Add'" style="margin-bottom: 15px;">
      <i class="fas fa-plus"></i> Add New Book
    </button>
    
    <!-- Bulk Actions Bar -->
    <div id="bulkActionsBar" class="bulk-actions-bar" style="display: none; margin-bottom: 15px; padding: 10px; background: var(--background-secondary); border-radius: 8px; align-items: center; gap: 10px;">
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" id="selectAllBooks" onchange="toggleSelectAll(this)">
        <span id="selectedCount">0 selected</span>
      </label>
      <button class="action-button" onclick="bulkHideBooks()" style="background: #f39c12;">
        <i class="fas fa-eye-slash"></i> Hide Selected
      </button>
      <button class="action-button" onclick="bulkShowBooks()" style="background: #27ae60;">
        <i class="fas fa-eye"></i> Show Selected
      </button>
      <button class="action-button" onclick="clearSelection()" style="background: #95a5a6;">
        <i class="fas fa-times"></i> Clear Selection
      </button>
    </div>
    
    <div id="spinner" class="spinner" style="display: none;"></div>

    <div class="cards-container products scroll-animate"
      style="{{#if books}}display: grid;{{else}}display: block;{{/if}}">
      {{#if books}}
      {{#each books}}
      <article class="book-card linked scroll-animate" id="{{this.id}}"
        style="transition-delay: {{multiply @index 0.1}}s;">
        <div class="book-checkbox-wrapper" style="position: absolute; top: 10px; left: 10px; z-index: 10;">
          <input type="checkbox" class="book-select-checkbox" data-book-id="{{this.id}}" onchange="updateBulkActions()">
        </div>
        <div class="badges">
          {{#if this.main}}
          <div class="badge badge-main" aria-label="Main resource">
            <i class="fas fa-star"></i> Main
          </div>
          {{/if}}
          {{#unless this.visible}}
          <div class="badge badge-hidden" style="background: #e74c3c;" aria-label="Hidden book">
            <i class="fas fa-eye-slash"></i> Hidden
          </div>
          {{/unless}}
          {{#if (eq ../filters.semester 'all')}}
          <div class="badge badge-semester" aria-label="Book semester">
            <i class="fas fa-graduation-cap"></i> {{this.semester}}
          </div>
          {{/if}}
          <div class="badge badge-category" aria-label="Book category">
            <i class="fas fa-book"></i> {{this.category}}
          </div>
        </div>
        <a href="/dashboard/Book/Edit/{{this.id}}" aria-label="View {{this.name}} details" class="book-link">
          <img src="{{this.imageURL}}" alt="Cover of {{this.name}}" loading="lazy" class="lazy-load"
            onerror="this.src='https://via.placeholder.com/300x400?text=No+Cover'">
        </a>
        <div class="Bdetails">
          <h3><a href="/dashboard/Book/Edit/{{this.id}}" class="book-title-link" title="{{this.name}}">{{this.name}}</a>
          </h3>
          <p title="{{this.description}}">{{this.description}}</p>
          <p title="{{this.UserName}}">Uploaded by: {{this.UserName}}</p>
        </div>
        <div class="actions">
          <button onclick="deleteProduct('{{this.id}}')" class="book-btn delete-btn" title="Delete book">
            <i class="fas fa-trash-alt"></i>
          </button>
          <a href="/dashboard/Book/Edit/{{this.id}}" class="book-btn edit-btn" title="Edit book">
            <i class="fas fa-edit"></i>
          </a>
          <a href="/dashboard/Book/{{this.id}}/Sections" class="book-btn sections-btn" title="Manage Sections">
            <i class="fas fa-list-ul"></i>
          </a>
        </div>
      </article>
      {{/each}}
      {{else}}
      <div class="no-results">
        <i class="fas fa-book-open" style="font-size: 3rem; margin-bottom: 1rem; color: var(--text-secondary);"></i>
        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">No materials found matching your criteria</p>
        <button class="btn btn-save" onclick="resetFilters()" style="margin: 0 auto;">
          <i class="fas fa-filter"></i> Reset Filters
        </button>
      </div>
      {{/if}}
    </div>


    {{#unless singleBookView}}
    <div class="pagination" id="pagination">
      {{#if (gt pagination.pages 1)}}
      <button {{#if (eq pagination.page 1)}}disabled{{/if}} onclick="goToPage({{subtract pagination.page 1}})"
        title="Previous page">
        <i class="fas fa-chevron-left"></i>
      </button>

      {{#if (gt pagination.page 2)}}
      <button onclick="goToPage(1)" title="First page">1</button>
      {{#if (gt pagination.page 3)}}
      <span style="padding: 0 10px; color: var(--text-secondary);">...</span>
      {{/if}}
      {{/if}}

      {{#each (range (max 1 (subtract pagination.page 2)) (min pagination.pages (add pagination.page 2)))}}
      <button {{#if (eq this ../pagination.page)}}class="active" disabled{{/if}} onclick="goToPage({{this}})"
        title="Page {{this}}">{{this}}</button>
      {{/each}}

      {{#if (lt pagination.page (subtract pagination.pages 1))}}
      <span style="padding: 0 10px; color: var(--text-secondary);">...</span>
      <button onclick="goToPage({{pagination.pages}})" title="Last page">{{pagination.pages}}</button>
      {{/if}}

      <button {{#if (eq pagination.page pagination.pages)}}disabled{{/if}} onclick="goToPage({{add pagination.page 1}})"
        title="Next page">
        <i class="fas fa-chevron-right"></i>
      </button>
      {{/if}}
    </div>
    <div class="pagination-info" id="paginationInfo">
      Showing {{add (multiply (subtract pagination.page 1) pagination.limit) 1}}-{{min (multiply pagination.page
      pagination.limit) pagination.total}} of {{pagination.total}} item{{#if (gt pagination.total 1)}}s{{/if}}
    </div>
    {{/unless}}
  </div>
</section>
<script>
  function exportBooks() {
    const url = '/api/admin/Unilib/Book/Export';
    fetch(url, { credentials: 'include' })
      .then(r => { if (!r.ok) throw new Error('Export failed'); return r.json(); })
      .then(data => {
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        const ts = new Date().toISOString().replace(/[:.]/g, '-');
        a.download = `unilib-books-${ts}.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
      })
      .catch(err => { console.error(err); alert('Failed to export books.'); });
  }
  
  async function deleteProduct(productId) {
    if (confirm('Are you sure you want to delete this product?')) {
      try {
        const response = await fetch(`/api/admin/Unilib/Book/Delete/${productId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        if (response.ok) {
          alert('Product deleted successfully.');
          window.location.reload();
        } else {
          alert('Failed to delete the product. Please try again.');
        }
      } catch (error) {
        console.error('Error deleting product:', error);
        alert('An error occurred while deleting the product.');
      }
    }
  }

  // Bulk Actions Functions
  function updateBulkActions() {
    const checkboxes = document.querySelectorAll('.book-select-checkbox:checked');
    const count = checkboxes.length;
    const bulkBar = document.getElementById('bulkActionsBar');
    const selectedCount = document.getElementById('selectedCount');
    const selectAllCheckbox = document.getElementById('selectAllBooks');
    
    if (count > 0) {
      bulkBar.style.display = 'flex';
      selectedCount.textContent = `${count} selected`;
    } else {
      bulkBar.style.display = 'none';
    }
    
    // Update select all checkbox state
    const allCheckboxes = document.querySelectorAll('.book-select-checkbox');
    selectAllCheckbox.checked = allCheckboxes.length > 0 && count === allCheckboxes.length;
    selectAllCheckbox.indeterminate = count > 0 && count < allCheckboxes.length;
  }

  function toggleSelectAll(checkbox) {
    const bookCheckboxes = document.querySelectorAll('.book-select-checkbox');
    bookCheckboxes.forEach(cb => cb.checked = checkbox.checked);
    updateBulkActions();
  }

  function clearSelection() {
    document.querySelectorAll('.book-select-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('selectAllBooks').checked = false;
    updateBulkActions();
  }

  async function bulkHideBooks() {
    const selectedIds = Array.from(document.querySelectorAll('.book-select-checkbox:checked'))
      .map(cb => parseInt(cb.dataset.bookId));
    
    if (selectedIds.length === 0) {
      alert('No books selected');
      return;
    }

    if (!confirm(`Hide ${selectedIds.length} book(s)?`)) return;

    try {
      const response = await fetch('/api/admin/Unilib/Book/BulkVisibility', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ bookIds: selectedIds, visible: false })
      });

      const data = await response.json();
      if (response.ok) {
        alert(data.message);
        window.location.reload();
      } else {
        alert(data.error || 'Failed to hide books');
      }
    } catch (error) {
      console.error('Error hiding books:', error);
      alert('An error occurred while hiding books.');
    }
  }

  async function bulkShowBooks() {
    const selectedIds = Array.from(document.querySelectorAll('.book-select-checkbox:checked'))
      .map(cb => parseInt(cb.dataset.bookId));
    
    if (selectedIds.length === 0) {
      alert('No books selected');
      return;
    }

    if (!confirm(`Show ${selectedIds.length} book(s)?`)) return;

    try {
      const response = await fetch('/api/admin/Unilib/Book/BulkVisibility', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ bookIds: selectedIds, visible: true })
      });

      const data = await response.json();
      if (response.ok) {
        alert(data.message);
        window.location.reload();
      } else {
        alert(data.error || 'Failed to show books');
      }
    } catch (error) {
      console.error('Error showing books:', error);
      alert('An error occurred while showing books.');
    }
  }
</script>
<script src="/Assets/Scripts/unilib.js"></script>