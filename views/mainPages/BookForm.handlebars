{{! Single Book Form View for Add and Edit }}
{{#section 'head'}}
<link rel="stylesheet" href="/Assets/Styles/common-admin.css?v={{appVersion}}">
<style>
  /* Add/Edit Book Page Styles */
  .add-book-content {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 2rem;
    align-items: start;
  }

  .book-preview-section {
    position: sticky;
    top: 100px;
    width: 100%;
  }

  .book-preview-section .cards-container {
    display: flex;
    justify-content: center;
  }

  .book-preview-section .book-card {
    width: 100%;
    max-width: 300px;
    opacity: 1 !important;
    transform: translateY(0) scale(1) !important;
  }

  /* Badge Styles for Preview */
  .book-preview-section .badges {
    position: absolute;
    top: 10px;
    left: 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    z-index: 10;
  }

  .form-section .profile-container {
    background: rgba(10, 20, 20, 0.6);
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    border: 1px solid var(--main-border-color);
    backdrop-filter: blur(10px);
  }

  .form-section .profile-header h2 {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 1.5rem;
  }

  .form-section .form-group {
    margin-bottom: 1.5rem;
  }

  .form-section .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--text-secondary);
    font-weight: 600;
  }

  .form-section .form-group input,
  .form-section .form-group select {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--main-border-color);
    border-radius: 8px;
    background: rgba(16, 28, 28, 0.5);
    color: var(--text-primary);
    font-size: 1rem;
    transition: all 0.3s ease;
  }

  .form-section .form-group input:focus,
  .form-section .form-group select:focus {
    border-color: var(--accent);
    outline: none;
    box-shadow: 0 0 0 2px rgba(0, 184, 148, 0.2);
    background: rgba(16, 28, 28, 0.8);
  }

  /* Custom select and multiselect styles ðŸ”§ */
  .form-section .form-group select {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    padding-right: 2.25rem;
    background-position: right 0.75rem center;
    background-repeat: no-repeat;
    background-size: 0.85rem 0.85rem;
  }

  .form-section .form-group select::-ms-expand { display: none; }

  .custom-multiselect {
    position: relative;
    border: 1px solid var(--main-border-color);
    border-radius: 8px;
    background: rgba(16, 28, 28, 0.6);
    padding: 0.45rem;
    min-height: 44px;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
  }

  .custom-multiselect.has-selection { padding-bottom: 0.5rem; }

  .multiselect-tags {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    align-items: center;
    min-height: 36px;
    width: 100%;
  }

  .multiselect-tags .placeholder {
    color: var(--text-secondary);
    padding: 0.2rem 0.4rem;
    font-size: 0.95rem;
  }

  .tag {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: rgba(0, 0, 0, 0.32);
    border-radius: 16px;
    padding: 0.25rem 0.5rem;
    color: var(--text-primary);
    font-size: 0.9rem;
  }

  .tag-remove {
    background: transparent;
    border: none;
    color: var(--text-primary);
    margin-left: 6px;
    cursor: pointer;
    font-size: 1rem;
    line-height: 1;
  }

  .multiselect-dropdown {
    position: absolute;
    left: 0;
    right: 0;
    top: calc(100% + 6px);
    background: rgba(12, 18, 18, 0.98);
    border: 1px solid var(--main-border-color);
    border-radius: 8px;
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.6);
    max-height: 240px;
    overflow: auto;
    z-index: 50;
    padding: 8px;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .multiselect-option {
    padding: 0.5rem;
    border-radius: 6px;
    cursor: pointer;
    color: var(--text-primary);
  }

  .multiselect-option:hover { background: rgba(0, 184, 148, 0.06); }
  .multiselect-option.selected { background: rgba(0, 184, 148, 0.12); border-left: 4px solid var(--accent); padding-left: 0.6rem; }

  .hidden { display: none; }

  /* tiny utility to keep native select accessible but visually hidden */
  .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }

  @media (max-width: 768px) {
    .multiselect-dropdown { position: static; max-height: 180px; }
  }

  .form-section .buttons.full {
    width: 100%;
    padding: 0.75rem;
    background: var(--accent);
    color: var(--text-dark);
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .form-section .buttons.full:hover {
    background: var(--secondary);
    box-shadow: 0 6px 12px rgba(67, 233, 123, 0.25);
  }

  .form-section .buttons.full:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }


  @media (max-width: 768px) {

    .add-book-content {
      grid-template-columns: 1fr;
    }

    .book-preview-section {
      position: static;
      top: auto;
    }

    .book-preview-section .book-card {
      max-width: 100%;
    }
  }
</style>
<title>{{#if isEdit}}Edit Book{{else}}Add Book{{/if}} - Unilib Admin Dashboard</title>
{{/section}}

<section class="about" id="books">
  <div class="content">
    <div class="add-book-content">
      <div class="book-preview-section">
        <div class="cards-container products">
          <article class="book-card linked" {{#if id}}id="{{id}}" {{/if}}>
            <div class="badges">
              {{#if book.main}}
              {{#unless (eq book.category 'LabManuals')}}
              <div class="badge badge-main" aria-label="Main resource">
                <i class="fas fa-star"></i> Main
              </div>
              {{/unless}}
              {{/if}}
              {{#if book.semester}}
              <div class="badge badge-semester" aria-label="Book semester">
                <i class="fas fa-graduation-cap"></i> {{join book.semester}}
              </div>
              {{/if}}
              {{#if book.category}}
              <div class="badge badge-category" aria-label="Book category">
                <i class="fas fa-book"></i> {{book.category}}
              </div>
              {{/if}}
            </div>
            <a id="bookurl" href="{{#if book}}{{book.link}}{{/if}}" target="_blank" aria-label="All">
              <img id="bookcover" src="{{#if book}}{{book.imageURL}}{{else}}/BookCovers/BookCover_Template.webp{{/if}}"
                alt="Cover of {{#if book}}{{book.name}}{{else}}book name{{/if}}" loading="lazy">
            </a>
            <div class="Bdetails">
              <h3 id="bookname" data-org="{{#if book}}{{book.name}}{{/if}}">{{#if book}}{{book.name}}{{/if}}</h3>
              <p id="bookdesciption" data-org="{{#if book}}{{book.description}}{{/if}}">{{#if
                book}}{{book.description}}{{/if}}</p>
            </div>
            <div class="actions">
              <a id="bookurl1" href="{{#if book}}{{book.link}}{{/if}}" target="_blank" class="btn btn-save"
                aria-label="View All">
                <i class="fas fa-eye" aria-hidden="true"></i> View
              </a>
            </div>
          </article>
        </div>
      </div>

      <div class="form-section">
        <div class="profile-container">
          <div class="profile-header">
            <h2><i class="fas fa-book"></i> Book Details <span style="margin:auto"><i class="fas fa-eye"></i> Views: {{#if book}}{{book.views}}{{else}}0{{/if}}</span></h2>
            <span>Created: {{#if book}}{{book.created_at}}{{/if}}</span>
          </div>
          <div class="profile-details">
            <form class="profile-form" id="bookForm" data-is-edit="{{isEdit}}" {{#if id}}data-book-id="{{id}}" {{/if}}>

              <div class="form-group">
                <label for="name"><i class="fas fa-heading"></i> Book Name:</label>
                <input type="text" value="{{#if book}}{{book.name}}{{else}}book name{{/if}}"
                  data-org="{{#if book}}{{book.name}}{{/if}}" id="name" name="name" placeholder="Enter book name"
                  required/>
              </div>

              <div class="form-group">
                <label for="category"><i class="fas fa-folder"></i> Category:</label>
                <select id="category" name="category" data-org="{{#if book}}{{book.category}}{{/if}}" required>
                  <option value="All" {{#if (eq book.category "All" )}}selected{{/if}}>All</option>
                  <option value="CourseBooks" {{#if (eq book.category "CourseBooks" )}}selected{{else}}{{#unless
                    book}}selected{{/unless}}{{/if}}>CourseBooks</option>
                  <option value="Softwares" {{#if (eq book.category "Softwares" )}}selected{{/if}}>Softwares</option>
                  <option value="LabManuals" {{#if (eq book.category "LabManuals" )}}selected{{/if}}>LabManuals</option>
                  <option value="Other" {{#if (eq book.category "Other" )}}selected{{/if}}>Other</option>
                </select>
              </div>

              <div class="form-group">
                <label for="description"><i class="fas fa-align-left"></i> Description:</label>
                <input id="description"
                  value="{{#if book}}{{book.description}}{{else}}author name or other description{{/if}}"
                  data-org="{{#if book}}{{book.description}}{{/if}}" name="description"
                  placeholder="Enter book description" required />
              </div>

              <div class="form-group">
                <label for="imageURL"><i class="fas fa-image"></i> Image URL:</label>
                <input id="imageURL"
                  value="{{#if book}}{{book.imageURL}}{{else}}/BookCovers/BookCover_Template.webp{{/if}}"
                  data-org="{{#if book}}{{book.imageURL}}{{/if}}" name="imageURL" placeholder="Enter image URL" required
                  {{#unless (eq role "SuperAdmin" )}}readonly title="You Don't Have Permission To Change Img URL"
                  {{/unless}} />
              </div>

              <div class="form-group">
                <label for="link"><i class="fas fa-link"></i> Book URL:</label>
                <input type="url"
                  value="{{#if book}}{{book.link}}{{else}}https://drive.google.com/file/d/../view{{/if}}"
                  data-org="{{#if book}}{{book.link}}{{/if}}" id="link" name="link" placeholder="Enter book URL"
                  required />
              </div>

              <div class="form-group">
                <label for="semester"><i class="fas fa-graduation-cap"></i> Semester(s):</label>

                <!-- Custom multiselect UI: keeps native select in DOM for accessibility & form submission -->
                <div class="custom-multiselect" id="semesterMulti" role="listbox" aria-label="Semester selection">
                  <div class="multiselect-tags" tabindex="0" aria-live="polite"></div>
                  <div class="multiselect-dropdown hidden" aria-hidden="true"></div>
                </div>

                <!-- Native select is visually hidden but remains the authoritative form control -->
                <select id="semester" name="semester" data-org='{{json book.semester}}' multiple required class="sr-only">
                  <option value="all" {{#if (eq book.semester "all")}}selected{{/if}}>All Semesters</option>
                  <option value="Semester1" {{#if (includes book.semester "Semester1" )}}selected{{/if}}>Semester 1</option>
                  <option value="Semester2" {{#if (includes book.semester "Semester2" )}}selected{{/if}}>Semester 2</option>
                  <option value="Semester3" {{#if (includes book.semester "Semester3" )}}{{else}}{{#unless book}}selected{{/unless}}{{/if}}>Semester 3</option>
                  <option value="Semester4" {{#if (includes book.semester "Semester4" )}}selected{{/if}}>Semester 4</option>
                  <option value="Semester5" {{#if (includes book.semester "Semester5" )}}selected{{/if}}>Semester 5</option>
                  <option value="Semester6" {{#if (includes book.semester "Semester6" )}}selected{{/if}}>Semester 6</option>
                  <option value="Semester7" {{#if (includes book.semester "Semester7" )}}selected{{/if}}>Semester 7</option>
                  <option value="Semester8" {{#if (includes book.semester "Semester8" )}}selected{{/if}}>Semester 8</option>
                </select>
              </div> 

              <div class="form-group">
                <label for="main"><i class="fas fa-star"></i> Main Resource:</label>
                <select id="main" name="main" data-org="{{#if book}}{{book.main}}{{/if}}" required>
                  <option value="true" {{#if (eq book.main "true" )}}selected{{/if}}>Yes</option>
                  <option value="false" {{#if (eq book.main "false" )}}selected{{else}}{{#unless
                    book}}selected{{/unless}}{{/if}}>No</option>
                </select>
              </div>

              <div class="form-group">
                <label for="visible"><i class="fas fa-eye"></i> Visibility:</label>
                <select id="visible" name="visible" data-org="{{#if book}}{{book.visible}}{{/if}}" required>
                  <option value="true" {{#if (eq book.visible "false" )}}{{else}}selected{{/if}}>Visible</option>
                  <option value="false" {{#if (eq book.visible "false" )}}selected{{/if}}>Hidden</option>
                </select>
              </div>


              <a class="buttons full" {{#if isEdit}}href="/dashboard/Book/{{id}}/Sections" {{/if}} {{#unless isEdit}}
                title="Create the Book to Enable Manage Sections Button" {{/unless}} id="manageSectionButton">
                <i class="fas fa-edit"></i>
                {{#if isEdit}}
                Manage Sections
                {{else}}
                Create the Book to Enable Manage Sections Button
                {{/if}}
              </a>

              <button class="buttons full" id="submitButton">
                <i class="fas fa-save"></i>
                {{#if isEdit}}Edit Book{{else}}Add Book{{/if}}
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
<script>
  // Shared preview update for both Add and Edit
  function updateBookCard() {
    const name = document.getElementById("name").value;
    const description = document.getElementById("description").value;
    const imageURL = document.getElementById("imageURL").value;
    const link = document.getElementById("link").value;
    const mainValue = document.getElementById("main").value;
    const category = document.getElementById("category").value;
    const semesterEl = document.getElementById("semester");
    const selectedSemesters = semesterEl ? Array.from(semesterEl.selectedOptions).map(o => o.value) : [];

    document.getElementById("bookname").textContent = name;
    document.getElementById("bookdesciption").textContent = description;
    document.getElementById("bookcover").src = imageURL;
    document.getElementById("bookurl").href = link;
    document.getElementById("bookurl1").href = link;

    // Update badges
    const badgesContainer = document.querySelector(".book-card .badges");
    if (badgesContainer) {
      // Clear existing badges
      badgesContainer.innerHTML = '';

      // Add main badge if applicable
      if (mainValue === "true") {
        const mainBadge = document.createElement("div");
        mainBadge.className = "badge badge-main";
        mainBadge.innerHTML = '<i class="fas fa-star"></i> Main';
        badgesContainer.appendChild(mainBadge);
      }

      // Add semester badges
      if (selectedSemesters && selectedSemesters.length > 0) {
        selectedSemesters.forEach(s => {
          const semesterBadge = document.createElement("div");
          semesterBadge.className = "badge badge-semester";
          semesterBadge.innerHTML = `<i class="fas fa-graduation-cap"></i> ${s}`;
          badgesContainer.appendChild(semesterBadge);
        });
      }

      // Add category badge
      if (category && category !== "All") {
        const categoryBadge = document.createElement("div");
        categoryBadge.className = "badge badge-category";
        categoryBadge.innerHTML = `<i class="fas fa-book"></i> ${category}`;
        badgesContainer.appendChild(categoryBadge);
      }
    }
  }

  ["name", "description", "imageURL", "link", "main", "category", "semester", "visible"].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener("input", updateBookCard);
      el.addEventListener("change", updateBookCard);
    }
  });

  updateBookCard();

  // Unified submit handler
  document.getElementById("bookForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const form = e.target;
    const submitButton = document.getElementById("submitButton");
    submitButton.disabled = true;
    submitButton.textContent = (form.dataset.isEdit === 'true') ? "Editing..." : "Adding...";

    // gather selected semesters and expand a logical "all" to actual enum values the DB accepts
    let semesterSelected = Array.from(document.getElementById("semester").selectedOptions).map(o => o.value);
    const ALL_SEMESTERS = ['Semester1','Semester2','Semester3','Semester4','Semester5','Semester6','Semester7','Semester8'];
    if (semesterSelected.includes('all')) {
      semesterSelected = ALL_SEMESTERS.slice();
    }

    const payload = {
      name: document.getElementById("name").value,
      category: document.getElementById("category").value,
      description: document.getElementById("description").value,
      imageURL: document.getElementById("imageURL").value,
      link: document.getElementById("link").value,
      semester: semesterSelected,
      main: document.getElementById("main").value,
      visible: document.getElementById("visible").value,
    };

    try {
      let url;
      if (form.dataset.isEdit === 'true') {
        const bookId = form.dataset.bookId;
        url = `/api/admin/Unilib/Book/Edit/${bookId}`;
      } else {
        url = `/api/admin/Unilib/Book/Add`;
      }

      const response = await fetch(url, {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const result = await response.json();
      if (response.ok) {
        alert(result.message);
        // Redirect for Add, reload for Edit to show changes
        if (form.dataset.isEdit === 'true') window.location.reload();
        else window.location.href = '/dashboard';
      } else {
        alert(result.error || 'Something went wrong');
      }
    } catch (err) {
      console.error('Error submitting form:', err);
      alert('Failed to submit form.');
    } finally {
      submitButton.disabled = false;
      submitButton.textContent = (form.dataset.isEdit === 'true') ? 'Edit Book' : 'Add Book';
    }
  });

  // Initialize a lightweight custom multiselect for the Semester field ðŸ”§
  (function initCustomMultiselect() {
    function createMultiselect(selectId) {
      const select = document.getElementById(selectId);
      if (!select) return;
      const wrapper = document.getElementById(selectId + 'Multi');
      const tags = wrapper.querySelector('.multiselect-tags');
      const dropdown = wrapper.querySelector('.multiselect-dropdown');

      // If server-rendered select had its values encoded in data-org, parse and apply them.
      // This runs even if no options appear selected due to rendering differences.
      try {
        let org = select.getAttribute('data-org') || select.dataset.org;
        if (org) {
          let parsed = org;
          try { parsed = JSON.parse(org); } catch (e) { /* not JSON, keep as string */ }

          // Handle comma-separated string like "Semester1,Semester2"
          if (typeof parsed === 'string' && parsed.includes(',')) {
            parsed = parsed.split(',').map(s => s.trim()).filter(Boolean);
          }

          const ALL_SEM = ['Semester1','Semester2','Semester3','Semester4','Semester5','Semester6','Semester7','Semester8'];
          if (parsed === 'all' || parsed === 'All' || (Array.isArray(parsed) && parsed.includes('all'))) {
            Array.from(select.options).forEach(o => { if (o.value.startsWith('Semester')) o.selected = true; });
          } else if (Array.isArray(parsed)) {
            // Protect against parsed being empty array
            if (parsed.length > 0) {
              Array.from(select.options).forEach(o => { o.selected = parsed.includes(o.value); });
            }
          } else if (typeof parsed === 'string') {
            // single value
            Array.from(select.options).forEach(o => { o.selected = (o.value === parsed); });
          }
        }
      } catch (err) {
        console.warn('semester init parse failed', err);
      }

      // Build dropdown options from native select
      dropdown.innerHTML = '';
      Array.from(select.options).forEach(opt => {
        const item = document.createElement('div');
        item.className = 'multiselect-option' + (opt.selected ? ' selected' : '');
        item.setAttribute('data-value', opt.value);
        item.textContent = opt.textContent;
        dropdown.appendChild(item);
      });

      function refreshTags() {
        tags.innerHTML = '';
        const selected = Array.from(select.selectedOptions);
        if (selected.length === 0) {
          const placeholder = document.createElement('span');
          placeholder.className = 'placeholder';
          placeholder.textContent = 'Select semesters...';
          tags.appendChild(placeholder);
          wrapper.classList.remove('has-selection');
        } else {
          wrapper.classList.add('has-selection');
          selected.forEach(o => {
            const tag = document.createElement('span');
            tag.className = 'tag';
            tag.textContent = o.textContent;
            const rem = document.createElement('button');
            rem.type = 'button';
            rem.className = 'tag-remove';
            rem.innerHTML = '&times;';
            rem.addEventListener('click', (ev) => {
              ev.stopPropagation();
              o.selected = false;
              Array.from(dropdown.children).forEach(d => { if (d.dataset.value === o.value) d.classList.remove('selected'); });
              refreshTags();
              updateBookCard();
            });
            tag.appendChild(rem);
            tags.appendChild(tag);
          });
        }
      }

      dropdown.addEventListener('click', (e) => {
        const item = e.target.closest('.multiselect-option');
        if (!item) return;
        const value = item.dataset.value;
        const opt = Array.from(select.options).find(o => o.value === value);
        if (!opt) return;

        const willSelect = !opt.selected;
        if (value === 'all' && willSelect) {
          // if user selects 'All', mark all concrete semesters selected (avoid sending invalid 'all' enum to DB)
          Array.from(select.options).forEach(o => {
            if (o.value.startsWith('Semester')) o.selected = true;
            else o.selected = false;
          });
          Array.from(dropdown.children).forEach(d => {
            d.classList.toggle('selected', d.dataset.value.startsWith('Semester'));
            if (d.dataset.value === 'all') d.classList.remove('selected');
          });
        } else if (value === 'all' && !willSelect) {
          // deselecting 'All' will clear all semesters
          Array.from(select.options).forEach(o => o.selected = false);
          Array.from(dropdown.children).forEach(d => d.classList.remove('selected'));
        } else {
          opt.selected = willSelect;
          if (select.querySelector('option[value="all"]')?.selected && value !== 'all') {
            select.querySelector('option[value="all"]').selected = false;
            Array.from(dropdown.children).forEach(d => { if (d.dataset.value === 'all') d.classList.remove('selected'); });
          }
          item.classList.toggle('selected', willSelect);
        }
        refreshTags();
        updateBookCard();
      });

      tags.addEventListener('click', () => {
        dropdown.classList.toggle('hidden');
        wrapper.classList.toggle('open');
        dropdown.setAttribute('aria-hidden', dropdown.classList.contains('hidden'));
      });

      // close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!wrapper.contains(e.target)) {
          dropdown.classList.add('hidden');
          wrapper.classList.remove('open');
          dropdown.setAttribute('aria-hidden', 'true');
        }
      });

      // initial render
      refreshTags();
    }

    // init on DOM ready
    try { createMultiselect('semester'); } catch (err) { console.error('Multiselect init failed', err); }
  })();
</script>

{{!-- Extra scripts or sections can be included if needed --}}